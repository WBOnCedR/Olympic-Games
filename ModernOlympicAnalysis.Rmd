---
title: "Olympic Games"
output:
  html_document:
    df_print: paged
  pdf_document:
    keep_tex: true
    latex_engine: xelatex
fontsize: 11pt
geometry: margin=2.5cm
mainfont: Times New Roman
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,     # larghezza in pollici
  fig.height = 5,    # altezza in pollici
  dpi = 300          # risoluzione
)
```

# Olympics

In this study I will interrogate the data from the Olympic events to get some interesting insight. The data are from [kaggle/piterfm](https://www.kaggle.com/datasets/piterfm/olympic-games-medals-19862018) and from [126 Years of Historical Olympic Dataset](https://www.kaggle.com/datasets/muhammadehsan02/126-years-of-historical-olympic-dataset) Even though the data cover a period that goes from 1896, in this study i will focus on the games after the downfall of the USSR, otherwise we will have the result from the USSR team until the downfall and after that, the result of all the new-born states. TO avoid that, and also to reduce the amount of relevant data i will consider only the Olympic games from the 1992 edition. 
Therefore, unfortunately:
- There are no results for qualification rounds. For instance, event 100-m men contains only final results without semi-finals and other hits. 
- There is no information about athletes for team competitions that consist of more than 2 participants. Only team records.

## Env SetUp

```{r}
rm(list=ls())

library(readr)

library(dplyr)
library(purrr)
library(tidyr)

library(stringr)

library(ggplot2)
library(gt)
library(patchwork)
library(ggcorrplot)
library(RColorBrewer)
library(maps)

library(visdat)
library(naniar)
library(mice)

library(arules)
```

Colors
```{r}
palette.qualitative <- brewer.pal(n = 9, name = "Set1") 
Red <- palette.qualitative[1]
Blue <- palette.qualitative[2]
Green <- palette.qualitative[3]
Violet <- palette.qualitative[4]
Orange <- palette.qualitative[5]
Yellow <- palette.qualitative[6]
Brown <- palette.qualitative[7]
Pink <- palette.qualitative[8]
Grey <- palette.qualitative[9]
```

Graphic functions

```{r}
theme_progetto <- function(base_size = 12, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) %+replace%
    theme(
      plot.title = element_text(
        face = "bold",
        size = base_size * 1.4,
        hjust = 0.5,
        margin = margin(b = 10)
      ),
      
      plot.subtitle = element_text(
        size = base_size * 1.1,
        hjust = 0.5,
        margin = margin(b = 15)
      ),
      
      plot.caption = element_text(
        size = base_size * 0.8,
        hjust = 0.5,
        margin = margin(t = 10)
      ),
      
      axis.title.x = element_text(
        size = base_size * 1.1,
        margin = margin(t = 10)
      ),
      axis.title.y = element_text(
        size = base_size * 1.1,
        angle = 90,
        margin = margin(r = 10)
      ),
      
      axis.text = element_text(size = base_size * 0.9),
      
      panel.grid.major = element_line(color = "grey85"),
      panel.grid.minor = element_blank(),
      
      legend.title = element_text(size = base_size * 1.1),
      legend.text  = element_text(size = base_size * 0.9),
      legend.position = "right", 
      legend.box = "vertical",
      
      plot.margin = margin(20, 20, 20, 20)
    )
}
```


```{r}
distribution_boxplots <- function(dataset = NA, vars = list(), 
                     fill = "Blue", color = "black"){
  boxplot_list <- list()
  for (var in vars) {
  h <- ggplot(dataset %>% filter(!is.na(.data[[var]])), 
              aes(y = .data[[var]])) +
    geom_boxplot(fill = fill, 
                 color = color) +
    scale_x_continuous(breaks = NULL)+
    labs(
      y = str_to_title(str_replace_all(var, "_", " ")),
      title = paste0("Distribution of ", str_to_title(str_replace_all(var, "_", " ")))
    ) + 
    theme_minimal() +
    theme_progetto()
    
  
  boxplot_list[[var]] <- h 
  }
  return(boxplot_list)
}

distribution_histograms <- function(dataset, vars, fill = "blue",
                       color = "black", position = "identity",
                       binwidth = 1, mean_line = F, mean_color = "red"){
  histogram_list <- list()
  for (var in vars) {
  
  h <- ggplot(dataset, aes(x = .data[[var]])) +
    geom_histogram(aes(y = after_stat(density)),
                   fill =  fill, 
                   color = color, 
                   position = position, 
                   binwidth = binwidth) +
    labs(
      x = str_to_title(str_replace(var, "_", " ")),
      y = "Density",
      title = paste0("Distribution of ", str_to_title(str_replace(var, "_", " ")))
    ) +
    theme_minimal() +
    theme_progetto()
  
  if (mean_line){
    mean_val <- mean(dataset[[var]], na.rm = TRUE)
    h <- h + 
      geom_vline(xintercept = mean_val,
               color = mean_color,
               linetype = "dashed", 
               linewidth = 1) 
  }
  
  histogram_list[[var]] <- h
  }
  return(histogram_list)

}



```


## Dataset

These datasets present a detailed country-wise record of Olympic medals from the first modern Olympics in 1896 to the most recent games in 2024. It provides insights into how different nations have performed over time, including their gold, silver, and bronze medal counts, overall rankings, and total medal tally.

```{r}
athlete <- read_csv("Data/olympic_athletes.csv")
hosts <- read_csv("Data/olympic_hosts.csv")
medals <- read_csv("Data/olympic_medals.csv") 
results <- read_csv("Data/olympic_results.csv")
```

This last dataset contatin the data from [Olympedia](https://www.olympedia.org/) and provide some additional information about the athlete that compete in the Olympic games.

```{r}
athlete.additional <- read_csv("Dataextraction/olympia_athletes_bio_parallel.csv")
```
## Data Preprocessing

### Athlete

```{r}
head(athlete)
```
```{r}
str(athlete)
```

I will now operate the following operation on the dataset:

- Filter only the athlete that has compete in the games starting from, the edition from 1992;
- Split the column *athlete_medals* into *gold*, *silver* and *broze* column;
- Add the debut age of each athlete;
- Calculate the current age (2025) of each athlete;
- Adding a binary variable, *medalist*, that is set 1 if the athlete has won any medal in his career;
- Make some format adjustment across some variables and select only the ones that are relevant; 

```{r}
athlete <- athlete %>%
  mutate(
    gold = replace_na(as.numeric(str_extract(athlete_medals, "\\d+(?=\\s*\\n+\\s*G)")), 0),
    silver = replace_na(as.numeric(str_extract(athlete_medals, "\\d+(?=\\s*\\n+\\s*S)")), 0),
    bronze = replace_na(as.numeric(str_extract(athlete_medals, "\\d+(?=\\s*\\n+\\s*B)")), 0),
    debut_age = as.integer(sub(".* (\\d{4})$", "\\1", first_game)) - athlete_year_birth,
    athlete_full_name = str_to_title(athlete_full_name),
    age = as.integer(format(Sys.Date(), "%Y")) - athlete_year_birth
  ) %>%
  mutate(medalist = ifelse(rowSums(across(c(gold, silver, bronze))) == 0, 0 , 1)) %>%
  filter(games_participations > 0) %>%
  rename("athlete_id" = athlete_url )%>%
   distinct(athlete_id, .keep_all = TRUE) %>%
  dplyr:::select(-athlete_medals, -bio)
```


### Athlete additional

```{r}
head(athlete.additional)
```

```{r}
str(athlete.additional)
```

I'll perform some necessary format correction to the dataset due to simplify the future operations.

```{r}
athlete.additional<-athlete.additional %>%
  mutate(athlete_full_name = str_to_title(athlete_full_name),
         height = as.integer(str_replace(height, " cm", "")),
         weight = str_replace(weight, "\\s*kg$", ""),
         sex = as.factor(sex),
         NOC_code = as.factor(NOC_code))%>%
  mutate(
         weight = case_when(
           str_detect(weight, "^-?\\d+\\s*-\\s*\\d+$") ~ {
             parts <- str_split(weight, "-", simplify = TRUE)
             rowMeans(matrix(as.numeric(parts), ncol = 2), na.rm = TRUE)
           },
          str_detect(weight, "^\\s*\\d+\\s*,\\s*\\d+\\s*$") ~ {
            parts <- str_split(weight, ",", simplify = TRUE)
            rowMeans(apply(parts, 2, as.numeric), na.rm = TRUE)
          },
          TRUE ~ as.numeric(as.numeric(weight)))) %>%
  rename("athlete_id" = athlete_url) %>%
  dplyr::select(-NOC)
```


### Medals

```{r}
head(medals)
```

```{r}
str(medals)
```
I'll perform some necessary format correction to the dataset due to simplify the future operations.

```{r}
medals <- medals %>%
  mutate(discipline_title = as.factor(discipline_title),
         event_gender = as.factor(event_gender),
         medal_type = as.factor(str_to_title(medal_type)),
         participant_type = as.factor(participant_type),
         NOC_code = as.factor(country_3_letter_code),
         athlete_full_name = str_to_title(athlete_full_name)) %>%
  rename("athlete_id" = athlete_url ) %>%
  dplyr::select(-country_code, -country_name, -country_3_letter_code) %>%
  group_by(discipline_title, slug_game, event_title, event_gender, 
           medal_type, participant_type, NOC_code) %>%
  reframe(athlete_id = list(athlete_id),
          athlete_full_name = list(athlete_full_name),
          participant_title = first(participant_title))
  
```


### Results

```{r}
head(results)
```
```{r}
str(results)
```
I'll perform some necessary format correction to the dataset due to simplify the future operations.


```{r}
results <- results %>%
  mutate(
    discipline_title = as.factor(discipline_title),
    medal_type = as.factor(str_to_title(medal_type)),
    participant_type = as.factor(participant_type),
    value_type = as.factor(value_type),
    NOC_code = as.factor(country_3_letter_code)
  ) %>%
  rename("athlete_id_temp" = athlete_url) %>%
  rowwise() %>%  
  mutate(
    athletes_names = list({
      if(is.na(athletes)) {
        NA_character_
      } else {
        tmp <- str_extract_all(athletes, "'([^']+)'")[[1]]
        if(length(tmp) == 0) {
          NA_character_
        } else {
          tmp <- gsub("'", "", tmp)
          tmp[seq(1, length(tmp), by = 2)]
        }
      }
    }),
    athletes_urls = list({
      if(is.na(athletes)) {
        NA_character_
      } else {
        str_extract_all(athletes, "https[^')]+")[[1]]
      }
    })
  ) %>%
  ungroup() %>% 
  mutate(
    participants_names = ifelse(
      participant_type == "Athlete",
      str_to_title(athlete_full_name),
      lapply(athletes_names, str_to_title)  
    ),
    participants_urls = ifelse(
      participant_type == "Athlete",
      athlete_id_temp, 
      athletes_urls   
    )
  ) %>%
  dplyr::select(-country_code, -country_name, -country_3_letter_code, -athletes_names,
         -athletes_urls, -athlete_id_temp, -athletes, -athlete_full_name) %>%
  rename("athlete_id" = participants_urls,
         "athlete_full_name" = participants_names)

```


```{r}
#str(results)
```


### Host

```{r}
head(hosts)
```
```{r}
str(hosts)
```
I'll perform some necessary format correction to the dataset due to simplify the future operations.

```{r}
hosts <- hosts %>%
  mutate(game_season = as.factor(game_season)) %>%
  rename("slug_game" = game_slug)
```


### Merging dataset

```{r}
athlete.full <- athlete %>%
  dplyr::select(-athlete_full_name) %>%
  inner_join(athlete.additional, by="athlete_id") 

results.full <- results %>%
  inner_join(hosts, by="slug_game") %>%
  filter(game_year >= 1992)

medals.full <- medals %>%
  inner_join(hosts, by="slug_game") %>%
  filter(game_year >= 1992)

hosts.full <- hosts %>%
  filter(game_year >= 1992)
```


```{r}
results_expanded <- results.full %>%
  dplyr::select(game_year, athlete_id, game_name) %>%
  unnest(athlete_id) %>%
  arrange(desc(game_year)) %>%
  group_by(athlete_id) %>%
  slice_head(n = 1) %>%
  ungroup()
 
athlete.full <- athlete.full %>%
  mutate(last_game_year = NA_real_)%>%
  left_join(results_expanded, by = "athlete_id", suffix = c("", "_new")) %>%
  mutate(last_game_year = coalesce(last_game_year, game_year)) %>%
  filter(last_game_year >= 1992)%>%
  dplyr::select(-game_year,-last_game_year,-game_name)
```

## Missing values & outliers

### Athlete

```{r}
summary(athlete.full)
```
```{r}
athlete.quantitative <- c("games_participations", "athlete_year_birth", "gold", 
                          "silver", "bronze", "debut_age", "age", "height",
                          "weight")
athlete.factorial <- c("medalist", "sex", "NOC_code")
athlete.qualitative <- c("first_game")
athlete.identifier <- c("athlete_id", "athlete_full_name")
```


```{r}
colSums(is.na(athlete.full))/nrow(athlete.full)
```
```{r}
gg_miss_var(athlete.full, show_pct = TRUE) +
  theme_minimal() 
```
```{r}
gg_miss_upset(athlete.full) 
```

```{r}
bplots <- distribution_boxplots(athlete.full, athlete.quantitative, fill = Blue) 
  
for (plot in bplots){
  print(plot)
}
```



```{r}
hplots <- distribution_histograms(athlete.full, athlete.quantitative, fill = Blue, 
                     mean_line = T, mean_color = Red)
for (plot in hplots){
  print(plot)
}
```


From the analysis of the missing data and the distribution of the variables, some problems stand out among the results:
- Some athlete debuts even before they were born.
- Some athlete debuts after 75 y/o.
- Some athlete attent more than 5 edition, even reaching 10 (at least 40 years of activity).
The first two problems probably come from an error in the data collecting process, given that the debut age is calculated by substracting the birth year of an athlete from the debut year. Looking at the boxplot of *athlete_year_birth* is possible to see that there's an evident cluster of record that stand outside every possible rare case (born before 1920). 
Now the problem could lie in the bad collection of the *athlete_year_birth* or in the collection of *first_game*. To verify this last possibility, I cross check the athlete born before 1950 in the `athlete.full` dataset with the `result.full` dataset.

Check for the oldest athletes

```{r}
old_athlete.to_check <- athlete.full%>%
  filter(athlete_year_birth <= 1950) %>%
  pull(athlete_id)

results_games <- results.full %>%
  dplyr::select(game_year, athlete_id, game_name) %>%
  unnest(athlete_id) %>%
  dplyr::select(athlete_id, game_name) %>%
  distinct()  

old_check <- athlete.full %>%
  filter(athlete_id %in% old_athlete.to_check) %>%
  anti_join(results_games, by = c("athlete_id", "first_game" = "game_name")) %>%
  pull(athlete_id)
athlete.full %>% filter(athlete_id %in% old_check)
```
```{r}
ggplot(athlete.full %>% filter(athlete_id %in% old_check),
       aes(y=debut_age)) +
  geom_boxplot(fill = Blue, color = "black") +
  theme_minimal() +
  labs(
    title = "Debut age distribution of oldest athletes",
    y = "Debut Age"
  ) +
  theme_progetto()
```


Check for the "super premature" athletes

```{r}
young_athlete.to_check <- athlete.full%>%
  filter(debut_age <= 15) %>%
  distinct(athlete_id) %>%
  pull(athlete_id)

young_check <- athlete.full %>%
  filter(athlete_id %in% young_athlete.to_check) %>%
  anti_join(results_games, by = c("athlete_id", "first_game" = "game_name")) %>%
  pull(athlete_id)

athlete.full %>% filter(athlete_id %in% young_check)
```


```{r}
ggplot(athlete.full %>% filter(athlete_id %in% young_check),
       aes(y=debut_age)) +
  geom_boxplot(fill = RColorBrewer::brewer.pal(n = 9, name = "Set1")[2]) +
  theme_minimal() +
  labs(
    title = "Debut age distribution of youngest athlete",
    y = "Debut Age"
  ) +
  theme_progetto()
```


```{r}
ggplot(athlete.full %>% filter(athlete_id %in% young_check),
       aes(x=debut_age)) +
  geom_histogram(fill = RColorBrewer::brewer.pal(n = 9, name = "Set1")[2],
                 color = "black",
                 binwidth = 1) +
  geom_vline(xintercept = 13,
             color = RColorBrewer::brewer.pal(n = 9, name = "Set1")[1],
             linetype = "dashed",
             size = 1)+
  theme_minimal() +
  labs(
    title = "Debut age distribution of youngest athlete",
    x = "Debut Age",
    y = "Frequency"
  ) +
  theme_progetto()
```
```{r}
length(young_check)/nrow(athlete.full%>%
 filter(debut_age <= 12))
```
The analysis over the birth years and the first game's year revealed that:
- For the oldest, that one that have a correspondence in the results dataset, the edition of 1992 was probably one of the latest, if not the last, and there isn't any evidence for errors;
- For the youngest, for athletes who recorded a debut age of less than 12, 91% do not find a correspondence in the results of the first Olympics that were recorded for them.
The decision is to delete the athlete that were born before 1950 that don't have a correspondence and the athletes with *debut_age* <= 12

```{r}
athlete.full <- athlete.full %>%
  filter(debut_age > 12,
         athlete_year_birth > 1950 | athlete_id %in% old_check)
```

Regarding the problem of the *game_partecipations*, I have checked and, even if very rare, there has been some very long-lived athlete (career talking), so nothing seem to be out of normal.

Regarding missing values, the ones coming from the `athlete` dataset are very few (less than 1%), and for those coming from the `athlete.additional`, they were probably not available. I save the indexes of those missing values to keep track of them and deal with them after according to the needs of the analysis.

```{r}
athlete.missing <- which(is.na(athlete.full), arr.ind = T)
```

### Medals

```{r}
#summary(medals.full)
```
```{r}
colSums(is.na(medals.full))/nrow(medals.full)
```
```{r}
gg_miss_var(medals.full) + 
  theme_minimal()
```
```{r}
gg_miss_upset(medals.full)
```
From the analysis over the missing values stands out that the vast majority of the missing values are in the *participant_title* variable, but that does not represent a problem given that most of the values of *participant_title* are the full name of *NOC_code*. Also it doesn't seem to be a relevant variable for any of the aim of the analysis.
The medals result that haven't associated any athlete/athletes to theme (those are the 1599 without both *athlete_fill_name* and *athlete_id*), are related to medals in "GameTeam" *partitipant_type* with more than 2 components, so I'll set the *athlete_full_name* and *athlete_id* as "*discipline_title*-*event_title*-Team 2+". In the end, for those record that has an `NA` only in *athlete_full_name* the idea is to check the `athlete.full` dataset and look if there's a unique correspondence between the name and the id.

```{r}
athlete_to_find <- medals.full %>%
  filter(is.na(athlete_id) & !is.na(athlete_full_name) &
           (participant_type != "GameTeam")) %>%
  distinct(athlete_full_name) %>%
    pull(athlete_full_name)
length(athlete_to_find)
```


```{r}
check_medals <- athlete.full %>%
  filter(athlete_full_name %in% athlete_to_find)
check_medals
```
It seems that among the 212 athlete names without an ID, any of them is present in the `athlete.full` dataset.  For the medals without an athlete associate I save the indexes just to know which one they are

```{r}
medals.missing_athlete.indexes <- which((is.na(medals.full$athlete_id)) &  (is.na(medals.full$athlete_full_name)))
```

```{r}
medals.full <- medals.full %>%
  rowwise() %>%
  mutate(
    athlete_full_name = list(case_when(
      is.na(athlete_full_name) & is.na(athlete_id) & participant_type == "GameTeam" ~ 
        paste0(discipline_title, "-", event_title, "-Team 2+"),
      TRUE ~ athlete_full_name
    )) ,
    athlete_id = list(case_when(
      is.na(athlete_id) ~ athlete_full_name,
      TRUE ~ athlete_id
    ))
  ) 
```

### Results

```{r}
head(results.full)
```
```{r}
#summary(results.full)
```

```{r}
colSums(is.na(results.full))/nrow(results.full)
```

```{r}
gg_miss_var(results.full) +
  theme_minimal()
```
```{r}
gg_miss_upset(results.full)
```
In this dataset the missing values are to be treated regarding the type of the variable. For example, in the variable *medal_type* a missing values probably stands for None, also considering that the ~90% of the data are missing. On the other end, the co-occurrence graph looks very messy. I'll try some others visualizations of the missing values just to try to understand more.

```{r}
results.full.viss_miss <- results.full %>%
  mutate(period = as.factor((game_year %/% 5) * 5))
vis_miss(results.full.viss_miss, facet = period,
         warn_large_data = FALSE)
```
```{r}
results.full.viss_miss %>%
  filter(period != 2020) %>%
  distinct(rank_equal)

results.full.viss_miss %>%
  filter(period == 2020) %>%
  distinct(rank_equal)
```
With these additional analysis it seem that the missing values in the variable *rank_equal* correspond to `FALSE`. 
For the variables *value_type* and *value_unit* for the moment doesn't seem to be there any significant pattern, just probably lack of the information from the source, but is too soon to tell. In the end, for the *athlete_id* I'll try to match with the `athlete.full` dataset as done with `medals.full`.

```{r}
name_to_id <- setNames(athlete.full$athlete_id, athlete.full$athlete_full_name)

fill_ids <- function(names, ids) {
  if (all(is.na(ids)) && !all(is.na(names))) {
    return(map_chr(names, ~ name_to_id[.x] %||% NA_character_))
  } else {
    
    return(ids)
  }
}

levels(results.full$medal_type) <- c(levels(results.full$medal_type), "None")
results.full <- results.full %>%
  mutate(athlete_id = map2(athlete_full_name, athlete_id, fill_ids),
         medal_type = replace_na(medal_type, "None"),
         rank_equal = replace_na(rank_equal, FALSE))
```

```{r}
gg_miss_var(results.full) +
  theme_minimal()
```
Now, leaving aside *value_unit* and *value_type*, the missing values in the dataset are:
- *medal_type* : NA means that any medals has been won;
- *athlete_full_name* and *athlete_id* at the same time : those records correspond for GameTeam results in which the group has more than 2 participant. I'll set the *athlete_full_name* and *athlete_id* as "*discipline_title*-*event_title*-Team 2+".
- *athlete_id* alone : NA means that that athlete doesn't have any id associate in the `athlete.full` dataset. I, as before, save the indexed of the data that are actually missing.
```{r}
results.full <- results.full %>%
  rowwise() %>%
  mutate(
    athlete_full_name = list(case_when(
      is.na(athlete_full_name) & is.na(athlete_id) & participant_type == "GameTeam" ~ 
        paste0(discipline_title, "-", event_title, "-Team 2+"),
      TRUE ~ athlete_full_name
    )) ,
    athlete_id = list(case_when(
      is.na(athlete_id) ~ athlete_full_name,
      TRUE ~ athlete_id
    ))
  ) 

results.missing <- which(is.na(results.full), arr.ind = T)
```

### Hosts

```{r}
summary(hosts.full)
```
```{r}
str(hosts.full)
```

## Descriptive

Now I'll visualize the data and try to extract some relevant insight.

```{r}
world_map <- map_data("world")
```


```{r}
for (i in unique(hosts.full$game_location)){
  print(paste0(i, " ", i %in% unique(world_map$region)))
}
```


```{r}

hosts.graphic <- hosts.full %>%
  mutate(game_location = case_when(
    game_location == "Republic of Korea" ~ "South Korea",
    game_location == "Russian Federation" ~ "Russia",
    game_location == "Great Britain" ~ "UK",
    game_location == "United States" ~ "USA",
    TRUE ~ game_location
  )) %>%
  group_by(game_location) %>%
  summarise(total = n()) %>%
  rename("region" = game_location) 

world.hosts.graphic <- hosts.graphic %>%
  right_join(world_map, by = "region") %>%
  mutate(total = replace_na(total, 0))
```

```{r}

ggplot(world.hosts.graphic, aes(x = long, y = lat, group = group, fill = total)) +
  geom_polygon(color = "white", size = 0.1) +
  scale_fill_gradient2(
    low = Grey, 
    mid = Orange, 
    high = Red,
    midpoint = 1,
    name = "Number of\nOlympic hosted",
    breaks = c(0, 1, 2),
    labels = c("0", "1", "2+")
  ) + 
  labs(
    title = "Countries hosting the Olympics since 1992",
    subtitle = "Number of Olympic editions hosted by country",
    x = NULL,
    y = NULL
    ) +
  scale_y_continuous(breaks = NULL) +
  scale_x_continuous(breaks = NULL) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  ) +
    theme_progetto()
```
```{r}
ggplot(hosts.graphic, aes(x = total, y = reorder(region, total))) +
  geom_bar(stat = "identity", fill = Blue, color = "white") +
  labs(
    x = "Number of hosts",
    y = "Region",
    title = "Countries hosting the Olympics since 1992"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor= element_blank(),
  ) +
  theme_progetto()
```
After 1992 the Olympic Games has been hosted spread all over the continents, except for Africa, with USA, Japan and China elected two times to be the hosting region.

```{r}
total.medals <- medals.full %>%
  group_by(slug_game, NOC_code) %>%
  summarise(
    total_medals = n(),
    game_season  = first(game_season),
    game_year = first(game_year),
    .groups = "drop"
  )
```

```{r}
ggplot(total.medals %>% 
         filter(game_season == "Summer") %>%
         group_by(NOC_code) %>%
         summarise(total = sum(total_medals)) %>%
         top_n(15, total),
         aes(x = total, y = reorder(NOC_code, total))) +
  geom_bar(stat = "identity", fill = Red, color = "white", size = 0.3)+
  labs(
    x = "Number of medals",
    y = "Nation (NOC Code)",
    title = "Nation's medal collection since 1992",
    subtitle = "Top 15 winning nations in summer editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 100, 20, 20)
  ) +
    theme_progetto()

```
```{r}
ggplot(total.medals %>% 
         filter(game_season == "Winter") %>%
         group_by(NOC_code) %>%
         summarise(total = sum(total_medals)) %>%
         top_n(15, total),
         aes(x = total, y = reorder(NOC_code, total))) +
  geom_bar(stat = "identity", fill = Blue, color = "white", size = 0.3)+
  labs(
    x = "Number of medals",
    y = "Nation (NOC Code)",
    title = "Nation's medal collection since 1992",
    subtitle = "Top 15 winning nations in winter editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 100, 20, 20)
  ) +
  theme_progetto()
```

As shown by the image, in the period after 1992 there has been an undisputed dominance by, in order, USA, China, Russia and Germany, follow by UK, Australia, France, Japan and Italy, regarding the summer editions. Indeed, looking at the winter editions, the podium change a bit, with the Germany as absolute ruler, followed by Norway and USA. Brilliant performance has been achieved also by Canada, Austria, Russia and Italy.


```{r}
ggplot(total.medals %>%
         filter((game_season == "Summer") &
                  NOC_code %in% c("USA", "CHN", "GER", "RUS", 
                                  "GBR", "AUS", "FRA", "JPN",
                                  "ITA"))%>%
         group_by(slug_game) %>%
         mutate(
           medals.perc = total_medals / sum(total_medals)
           ) %>%
         ungroup(), aes(x = game_year, y = medals.perc, group = NOC_code, col = NOC_code)) +
  geom_line(size = 1) +
  labs(
    x = "Year",
    y = "Medals Perc",
    title = "Dominance of nations over time",
    subtitle = "Only for summer editions",
    caption = "The medal percentage is given by number of medals won \n over total of the medals to be win in that year"
  )+
  scale_x_continuous(breaks = scales::breaks_width(5))+
  scale_y_continuous(labels = scales::label_percent(),
                     breaks = scales::breaks_width(.05))+
  scale_color_brewer(palette = "Paired")+
  theme_minimal() +
  theme_progetto()

```
```{r}
ggplot(total.medals %>%
         filter((game_season == "Winter") &
                  NOC_code %in% c("GER", "NOR", "USA", "CAN", 
                                  "AUT", "RUS", "ITA"))%>%
         group_by(slug_game) %>%
         mutate(
           medals.perc = total_medals / sum(total_medals)
           ) %>%
         ungroup(), aes(x = game_year, y = medals.perc, group = NOC_code, col = NOC_code)) +
  geom_line(size = 1) +
  labs(
    x = "Year",
    y = "Medals Perc",
    title = "Dominance of nations over time",
    subtitle = "Only for winter editions",
    caption = "The medal percentage is given by number of medals won \n over total of the medals to be win in that year"
  )+
  scale_x_continuous(breaks = scales::breaks_width(5))+
  scale_y_continuous(labels = scales::label_percent(),
                     breaks = scales::breaks_width(.05))+
  scale_color_brewer(palette = "Paired")+
  theme_minimal() +
  theme_progetto()
```

Looking at the evolution of the performance of the nations over the time, regarding the summer editions it is possible to observe a remarkable uptrend for UK, Japan and, a little bit less, China, while Germany shows a very significant downtrend. These patterns are not casual: the rise of Great Britain is strongly linked to the consistent investment plan launched after Sydney 2000 and reinforced towards London 2012, while Japan’s progression is connected to the preparation for Tokyo 2020 and a long-term investment in sports science. China’s boost reflects the national strategy to use sport as a symbol of prestige, with a clear turning point around Beijing 2008. On the contrary, Germany’s decline after the early ’90s is strongly related to the end of the centralized and highly efficient sports system of East Germany, which before the reunification guaranteed very high results. Therefore, is evident the undisputed dominance of USA across the years, based on an enormous pool of athletes, strong university sports programs and the ability to remain competitive in a wide variety of disciplines. In the last 20 years, also China emerges as a stable counterpart in the top positions.

Instead, looking at the winter games, a remarkable uptrend is highlighted by USA and Canada and, in the last 20 years, by Norway until nowadays domination. These dynamics can be explained by the rise of new winter disciplines (snowboard, freestyle) where USA have a cultural and commercial advantage, and by the Canadian program Own the Podium launched for Vancouver 2010, which gave a permanent boost. Norway’s extraordinary growth is the result of a long-lasting tradition in Nordic sports, combined with an ethical and sustainable approach that avoided the collapse seen in other countries after doping scandals. Otherwise the summer editions, here the dominance of Germany isn’t as evident as for the USA. In fact, in the short term the pole position clearly shifted to Norway, but looking at the cumulative number of medals Germany still keeps the overall lead — a lead that seems however increasingly under threat and likely to be surpassed in the next editions.

Let's inspect where the current dominating nations gain their power (USA, China and UK for the summer editions and Norway and Germany for the winter)


```{r}
medals.graphic1 <- medals.full %>%
    filter((game_season == "Summer") & 
            NOC_code %in% c("USA", "CHN", "GBR")) %>%
    group_by(NOC_code, event_gender, discipline_title) %>%
    summarise(medals = n(), .groups = "drop") 

medals.graphic2 <- medals.full %>%
    filter((game_season == "Winter") & 
            NOC_code %in% c("NOR", "GER")) %>%
    group_by(NOC_code, event_gender, discipline_title) %>%
    summarise(medals = n(), .groups = "drop") 

medals.graphic1.means <- medals.graphic1 %>%
  group_by(NOC_code) %>%
  summarise(means = round(mean(medals),2))
medals.graphic2.means <- medals.graphic2 %>%
  group_by(NOC_code) %>%
  summarise(means = round(mean(medals),2))
```


```{r}
data <- medals.graphic1 %>%
      group_by(NOC_code, discipline_title) %>%
      summarise(medals = sum(medals), .groups = "drop") %>%
      group_by(NOC_code) %>%
      slice_max(order_by = medals, n= 15)%>%
      ungroup()

p_list <- list()
for (NOC in unique(data$NOC_code)){
  p <- ggplot(data %>%
           filter(NOC_code == NOC),
  aes(x = discipline_title, y = medals)) +
      geom_bar(stat = "identity", fill = Red, color = "black") +
    geom_hline(yintercept = medals.graphic1.means %>%
                 filter(NOC_code == NOC) %>%
                 pull(means),
               linetype = "dashed",
               linewidth = 1)+
    labs(title = paste0("Best discipline of ", NOC),
         x = "Discipline",
         y = "Medals")+
    scale_y_continuous(limits = c(0, max(data$medals)*1.1),
                                  breaks = scales::breaks_width(50))+
    theme_minimal()+ 
    theme(
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = .8),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 100, 20, 20)
  )

  p_list[[NOC]] <- p
}

for (p in p_list){
  print(p)
}
```

```{r}
data <- medals.graphic2 %>%
      group_by(NOC_code, discipline_title) %>%
      summarise(medals = sum(medals), .groups = "drop") %>%
      group_by(NOC_code) %>%
      slice_max(order_by = medals, n= 15)%>%
      ungroup()

p_list <- list()
for (NOC in unique(data$NOC_code)){
  p <- ggplot(data %>%
           filter(NOC_code == NOC),
  aes(x = discipline_title, y = medals)) +
      geom_bar(stat = "identity", fill = Blue, color = "black") +
    geom_hline(yintercept =medals.graphic2.means %>%
                 filter(NOC_code == NOC) %>%
                 pull(means),
               linetype = "dashed",
               linewidth = 1)+
    labs(title = paste0("Best discipline of ", NOC),
         x = "Discipline",
         y = "Medals")+
    scale_y_continuous(limits = c(0, max(data$medals)*1.1),
                       breaks = scales::breaks_width(50))+
    labs(title = paste0("Best discipline of ", NOC))+
    theme_minimal()+ 
    theme(
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = .8),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 100, 20, 20)
  )
  
  p_list[[NOC]] <- p
}

for (p in p_list){
  print(p)
}
```
Regarding the summer editions USA have, on average, won around ~11.5 medals per discipline thanks to the absolute domination in athletic and swimming races and, less, thanks to gymnastics artistic and wrestling. This concentration is not casual: athletics and swimming provide many medal opportunities and the USA, with their huge pool of athletes, the strong college sport system and world-class infrastructures, have been able to consistently transform quantity into quality. China, with a lower average of ~9.55 medals per discipline, has been competitive, but not disruptive as USA in athletics and swimming, and has instead built its strength on a very wide variety of sports such as badminton, diving, shooting, table tennis, gymnastics artistic and weightlifting. This reflects a precise national strategy: investing on sports with many medal events or less global competition, supported by centralized talent identification and early specialization. UK, with an even lower average of ~6 medals per discipline, has been competitive in athletics, cycling track, rowing, sailing and swimming. Its success is the result of deliberate investments after Sydney 2000 and especially in preparation for London 2012, focusing on disciplines with strong national tradition and where technology and innovation could make the difference.

Looking at the winter editions, stands out a very similar situation: Norway, with an average of ~13.28 medals per discipline, owes its growing dominance mainly to cross country skiing, biathlon and alpine skiing, with some decent result also in nordic combined, ski jumping and speed skating. The reason for such supremacy lies in the cultural roots of skiing in Norway, practiced massively at every level, and in a federative system oriented to long-term and sustainable athlete development. Germany, with an average of ~10 medals per discipline, has been less dominant as Norway, but has been competitive across multiple disciplines such as alpine skiing, biathlon, bobsleigh, cross country skiing, luge, nordic combined, ski jumping and speed skating. The German model is more diversified than concentrated, reflecting a strong tradition in sliding sports and a well-developed infrastructure, which has guaranteed a broad but less absolute competitiveness.

```{r}
USA.winners <- results.full %>%
  filter((NOC_code == "USA") &
           (discipline_title %in% c("Athletics", "Swimming",
                                    "Gymnastics Artistic", "Wrestling"))&
           (medal_type != "None")) %>%
  unnest(cols = c(athlete_id, athlete_full_name)) %>%
  group_by(discipline_title, athlete_id, athlete_full_name ) %>%
  reframe(tot_medals = n())

NOR.winners <- results.full %>%
  filter((NOC_code == "NOR") &
           (discipline_title %in% c("Alpine Skiing", "Biathlon", "Cross Country Skiing"))&
           (medal_type != "None")) %>%
  unnest(cols = c(athlete_id, athlete_full_name)) %>%
  group_by(discipline_title, athlete_id, athlete_full_name ) %>%
  reframe(tot_medals = n())

GER.winners <- results.full %>%
  filter((NOC_code == "GER") &
           (discipline_title %in% c("Alpine Skiing", "Biathlon", "Cross Country Skiing",
                                    "Bobsleigh", "Luge", "Nordic Combined", "Ski Jumping",
                                    "Speed Skating"))&
           (medal_type != "None")) %>%
  unnest(cols = c(athlete_id, athlete_full_name)) %>%
  group_by(discipline_title, athlete_id, athlete_full_name ) %>%
  reframe(tot_medals = n())

CHN.winners <- results.full %>%
  filter((NOC_code == "CHN") &
           (discipline_title %in% c("Athletics", "Badminton", "Diving",
                                    "Shooting", "Gymnastics Artistic",
                                    "Swimming", "Table Tennis", "Weightlifting"))&
           (medal_type != "None")) %>%
  unnest(cols = c(athlete_id, athlete_full_name)) %>%
  group_by(discipline_title, athlete_id, athlete_full_name ) %>%
  reframe(tot_medals = n())
```

```{r NOR.winners, fig.width=10, fig.height=6, out.width='100%'}
ggplot(NOR.winners %>%
         top_n(15, tot_medals), 
         aes(x = tot_medals, y = reorder(athlete_full_name, tot_medals))) +
  geom_bar(stat = "identity", fill = Blue, color = "white", size = 0.3)+
  geom_vline(xintercept = ceiling((quantile(NOR.winners$tot_medals, .75) -
                                  quantile(NOR.winners$tot_medals, .25)) * 1.5 
                                + quantile(NOR.winners$tot_medals, .75)),
             linetype = "dashed",
               linewidth = 1)+
  labs(
    x = "Number of medals",
    y = "Athlete",
    title = "Norway's athletes medal collection since 1992",
    subtitle = "Top 15 winning Norway's atheletes in winter editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = .5),
    plot.subtitle = element_text(size = 12, hjust = .5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  )
```
```{r GER.winners, fig.width=10, fig.height=6, out.width='100%'}
ggplot(GER.winners  %>%
         top_n(15, tot_medals), 
         aes(x = tot_medals, y = reorder(athlete_full_name, tot_medals))) +
  geom_bar(stat = "identity", fill = Blue, color = "white", size = 0.3)+
  geom_vline(xintercept = ceiling((quantile(GER.winners$tot_medals, .75) -
                                  quantile(GER.winners$tot_medals, .25)) * 1.5 
                                + quantile(GER.winners$tot_medals, .75)),
             linetype = "dashed",
               linewidth = 1)+
  labs(
    x = "Number of medals",
    y = "Athlete",
    title = "Germany's athletes medal collection since 1992",
    subtitle = "Top 15 winning Germany's atheletes in winter editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin =margin(20, 20, 20, 20)
  )
```
```{r USA.winners, fig.width=10, fig.height=6, out.width='100%'}
ggplot(USA.winners  %>%
         top_n(15, tot_medals), 
         aes(x = tot_medals, y = reorder(athlete_full_name, tot_medals))) +
  geom_bar(stat = "identity", fill = Red, color = "white", size = 0.3)+
  geom_vline(xintercept = ceiling((quantile(USA.winners$tot_medals, .75) -
                                  quantile(USA.winners$tot_medals, .25)) * 1.5 
                                + quantile(USA.winners$tot_medals, .75)),
             linetype = "dashed",
               linewidth = 1)+
  labs(
    x = "Number of medals",
    y = "Athlete",
    title = "USA's athletes medal collection since 1992",
    subtitle = "Top 15 winning USA's atheletes in summer editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = .5),
    plot.subtitle = element_text(size = 12, hjust = .5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  )
```
```{r CHN.winners, fig.width=10, fig.height=6, out.width='100%'}
ggplot(CHN.winners %>%
         top_n(15, tot_medals), 
         aes(x = tot_medals, y = reorder(athlete_full_name, tot_medals))) +
  geom_bar(stat = "identity", fill = Red, color = "white", size = 0.3)+
  geom_vline(xintercept = ceiling((quantile(CHN.winners$tot_medals, .75) -
                                  quantile(CHN.winners$tot_medals, .25)) * 1.5 
                                + quantile(CHN.winners$tot_medals, .75)),
             linetype = "dashed",
               linewidth = 1)+
  labs(
    x = "Number of medals",
    y = "Athlete",
    title = "China's athletes medal collection since 1992",
    subtitle = "Top 15 winning  China's atheletes in summer editions"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, hjust = .5),
    plot.subtitle = element_text(size = 12, hjust = .5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  )
```
The single performance of the athletes reflects what has been observed before. For Norway, Marit Bjørgen (cross country skiing), Ole Einar Bjørndalen (biathlon), Bjørn Dæhlie (cross country skiing) and Kjetil André Aamodt (alpine skiing) have performed out of the ordinary, considered statistically as outliers, and their records symbolize the cultural centrality of winter sports in the country. Bjørgen is the most decorated Winter Olympian of all time, while Bjørndalen, known as the “King of Biathlon”, occupied the second place. Aamodt, is still the most successful alpine skier in Olympic history.
The USA show a similar trend of outstanding outliers, mainly in swimming and athletics: Michael Phelps is the most decorated Olympian ever, while Katie Ledecky has become the most dominant female swimmer in history. Allyson Felix is the most decorated American track and field athlete, and together with names like Ryan Lochte, Shannon Miller, Aaron Peirsol, Amanda Beard, Natalie Coughlin and Gary Hall Jr., they embody the American dominance across multiple cycles of the Games.
On the other hand, for Germany and China the distribution doesn’t denote such extreme outliers, even if remarkable athletes have left a significant mark: for Germany, Uschi Disl (biathlon) and Katja Seizinger (alpine skiing) are the most notable names, while many medals also came from collective events in sliding sports. For China, instead, the dominance has been more distributed, reflecting the national strategy: nevertheless, some athletes stand out for their consistency across multiple Games. In diving, Wu Minxia, Guo Jingjing, Qin Kai, Fu Mingxia, Chen Ruolin and Cao Yuan embody the tradition of excellence that made China the global powerhouse in this discipline. In addition, Wang Yifu in shooting and Sun Yang in swimming, have been central figures of the Chinese success, showing how the country’s performance, though less concentrated on single “outliers” like the USA or Norway, has been built on a solid core of multi-medalists across different disciplines.


```{r}
library(dplyr)
library(purrr)
library(tidyr)


library(MASS)
library("tree")
library(car)
library(caret)
library(ROCR)

library(stringr)

library(ggplot2)
library(gt)
library(patchwork)
library(ggcorrplot)
library(RColorBrewer)

library(visdat)
library(naniar)
library(mice)
```

# What does it takes to win a medal?

In this paper I'm going to explore, given the past performance of the athlete that took part at the Olympic games, what does it takes to be an Olympic medalist in the winter editions (like the 2026 Milano-Cortina Games). Then I'll try to estimate the chances that the Italian athletes have to win a medal.

## Data preparation

I create now the full dataset that I'm going to use after starting from `athlete.full` and `results.full` datasets. I immidiately remove the irrelevant variabiles and create some new "indicators" that might be usefull in the analysis:
- *Medalist*: wheather the results correspond to a medal or not;
- *HomeGame*: wheather the athlete was competing in is own nation or not;
- *participation_number*: the cumulative participations for each athlete;

Furthermore I'll work only on the winter edition, accordingly to the aim of the study. 

```{r}
ath <- athlete.full
rsl <- results.full %>% 
  mutate(game_location = case_when(
    game_location == "China"              ~ "CHN",
    game_location == "Japan"              ~ "JPN",
    game_location == "Republic of Korea"  ~ "KOR",
    game_location == "Brazil"             ~ "BRA",
    game_location == "Russian Federation" ~ "RUS",
    game_location == "Great Britain"      ~ "GBR",
    game_location == "Canada"             ~ "CAN",
    game_location == "Italy"              ~ "ITA",
    game_location == "Greece"             ~ "GRE",
    game_location == "United States"      ~ "USA",
    game_location == "Australia"          ~ "AUS",
    game_location == "Norway"             ~ "NOR",
    game_location == "Spain"              ~ "ESP",
    game_location == "France"             ~ "FRA",
    TRUE ~ NA_character_
  )) %>%
  mutate(
    HomeGame = case_when(
      game_location == NOC_code ~ 1,
      TRUE ~0
    ),
    Medalist = ifelse(
    medal_type == "None",
    0,
    1
  )
  )%>%
  dplyr::select(-slug_game, -game_end_date, -game_start_date,
         -game_name, -medal_type, -rank_equal,
         -rank_position, -value_unit, -value_type)
rsl.full <- rsl %>%
  unnest(c(athlete_full_name, athlete_id)) %>%
  filter(!grepl("Team 2\\+", athlete_id)) %>%
  inner_join(ath %>%
               dplyr::select(-medalist, -first_game, -age, 
                      -athlete_full_name)
             , by = "athlete_id") %>%
  mutate(result_age = game_year - athlete_year_birth,
         Medalist = as.factor(Medalist),
         sex = as.factor(sex),
         HomeGame = as.factor(HomeGame)) %>%
  rename("NOC_code" = NOC_code.y) %>%
  group_by(athlete_id) %>%
  mutate(
    participation_number = dense_rank(game_year)
  ) %>%
  ungroup()%>%
  dplyr::select(-NOC_code.x, -athlete_full_name, -athlete_id,
         -game_year, -gold, -silver, -bronze, -games_participations)

rsl.winter <- rsl.full %>%
  filter(game_season == "Winter")

```

```{r}
head(rsl.winter)
```

## Winter

### Data splitting

```{r}
train_size.w <- floor(nrow(rsl.winter)*.8)
set.seed(123)
train_index.w <- sample(seq_len(nrow(rsl.winter)), train_size.w)
train.w <- rsl.winter[train_index.w,]
test.w <- rsl.winter[-train_index.w,]

subtrain_size.w <- floor(nrow(train.w)*.65)
set.seed(123)
sub_train_index.w <- sample(seq_len(nrow(train.w)), subtrain_size.w)
sub_train.w <- train.w[sub_train_index.w,]
validation.w <- train.w[-sub_train_index.w,]
```

```{r}
round(prop.table(table(sub_train.w$Medalist)),2)
```

```{r}
round(prop.table(table(validation.w$Medalist)),2)
```
```{r}
round(prop.table(table(test.w$Medalist)),2)
```

After have divided the dataset into the necessary subset and have the same proportion, I proceed with the analysis of the missing values.

### Missing values

```{r}
str(sub_train.w)
```
```{r}
summary(sub_train.w)
```


```{r}
colSums(is.na(sub_train.w))/nrow(sub_train.w)
```
Regarding the missing values, the NA's in the age variables (*debut_age*, *result_age* and *athlete_year_birth*) are all related to lack of information from the source, but given that they're only less than 1% of the total, I'll simply won't consider them. 
The presence of NA's in *NOC_code* doesn't represent a problem given that I wont't probably use that variable in the algorithm.
Regarding *sex*, *height* and *weight*, they're missing due to lack of the information from the source. Given that they're only the ~5% and ~17% of the total, I'll impute them with the stratified by sex median for *height* and *weight* and *sex* with the mode of the class.

```{r}
sub_train.w <- sub_train.w[complete.cases(sub_train.w[, c("athlete_year_birth", "debut_age", "result_age")]), ]

imputation_values.w <- list(
  sex_mode = names(which.max(table(sub_train.w$sex))),
  median_by_sex = sub_train.w %>%
    group_by(sex) %>%
    summarize(
      height_median.w = median(height, na.rm = TRUE),
      weight_median.w = median(weight, na.rm = TRUE),
      .groups = 'drop'
    )
)
```

```{r}
male_height_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Male") %>%
  pull(height_median.w)

female_height_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Female") %>%
  pull(height_median.w)

male_weight_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Male") %>%
  pull(weight_median.w)

female_weight_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Female") %>%
  pull(weight_median.w)

sub_train.w <- sub_train.w %>%
  mutate(
    sex = ifelse(is.na(sex), imputation_values.w$sex_mode, as.character(sex)),
    height = case_when(
      sex == "Male" & is.na(height) ~ male_height_median.w,
      sex == "Female" & is.na(height) ~ female_height_median.w,
      TRUE ~ height
    ),
    weight = case_when(
      sex == "Male" & is.na(weight) ~ male_weight_median.w,
      sex == "Female" & is.na(weight) ~ female_weight_median.w,
      TRUE ~ weight
    )
  )

```


### Preliminar analysis

```{r}

numeric_data.w <- c("debut_age", "height", "weight", "participation_number", "result_age")
cat_data.w <- c("participant_type", "NOC_code", "HomeGame", "sex")

cor_df.w <- as.data.frame(as.table(round(cor(sub_train.w[,numeric_data.w], use = "pairwise.complete.obs", method = "pearson"),2)))

ggplot(cor_df.w, aes(x = Var1, y = Var2, fill = Freq)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(Freq, 2)), color = "black", size = 3) +
  scale_fill_gradient2(low = Blue, mid = "white", high = Red, midpoint = 0) +
  labs(
    title = "Correlation matrix between numerical variables"
  )+
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.title = element_blank(),
    plot.title = element_text(hjust = .5, vjust=.5)
  ) +
  coord_fixed()
```
```{r}
b_list.w <- list()
for (var in numeric_data.w) {
  h <-ggplot(sub_train.w, aes(y = .data[[var]])) +
    geom_boxplot(fill = Red, 
                 color = "black") +
    facet_wrap(~Medalist)+
    scale_x_continuous(breaks = NULL)+
    labs(
      y = str_to_title(str_replace_all(var, "_", " ")),
      title = paste0("Distribution of ", str_to_title(str_replace_all(var, "_", " ")))
    ) + 
    theme_minimal() +
    theme_progetto()
  b_list.w[[var]] <- h
}

for (plot in b_list.w){
  print(plot)
}

```
```{r}
for (var in numeric_data.w){
  cat("P value", var, "\n")
  print(t.test(sub_train.w[[var]] ~ sub_train.w$Medalist)$p.value)
}
```
```{r}
for (var in cat_data.w) {
  tbl <- round(table(sub_train.w[[var]], sub_train.w$Medalist),2)
  cat("P value", var, "\n")
  print(chisq.test(tbl))
}
  
```
Given the results, the variables that seem correct to consider are *debut_age*, *height*, *weight*, *participation_number*, *participant_type*, *sex* and *HomeGame*. From now I'll consider only theese variables. Also in general there aren't any particolar multicollinearity, if not between *Height* and *Weight* and *debut_age* and *result_age*.

```{r}
relevant_var.numeric.w <- c("debut_age", "height", "weight", "participation_number")
relevant_var.vategorical.w <- c("participant_type", "sex", "HomeGame")
```

Let's inspect the possbile presence of outlier

```{r}
distribution_boxplots(sub_train.w, var = relevant_var.numeric.w, fill = Blue)
```

```{r}
distribution_histograms(sub_train.w, var = relevant_var.numeric.w, fill = Blue)
```
```{r}
sub_train.w$debut_age <- log(sub_train.w$debut_age)
sub_train.w$participation_number <- log(sub_train.w$participation_number)
distribution_boxplots(sub_train.w, var = c("debut_age", "participation_number"), fill = Blue)
```

```{r}
distribution_histograms(sub_train.w, var = c("debut_age", "participation_number"), fill = Blue, binwidth = .5)
```


```{r}
for (var in relevant_var.numeric.w) {
  qqnorm(sub_train.w[sub_train.w$Medalist == 1, var][[1]], main=var)
  qqline(sub_train.w[sub_train.w$Medalist == 1, var][[1]], col=2)
}
```

```{r}
for (var in relevant_var.numeric.w) {
  qqnorm(sub_train.w[sub_train.w$Medalist == 0, var][[1]], main=var)
  qqline(sub_train.w[sub_train.w$Medalist == 0, var][[1]], col=2)
}
```
```{r}
plot_density.w <- list()
for(var in relevant_var.numeric.w){
  plot_density.w[[var]] <- ggplot(sub_train.w, aes_string(x = var, y = "after_stat(density)", col = "Medalist")) + 
    geom_density(aes(y = after_stat(density)), size=.8) + 
    scale_color_manual(values = c(Blue, Red)) + 
    labs(
      title = paste0("Density plot of ", str_to_title(str_replace_all(var, "_", " "))),
      x = str_to_title(str_replace_all(var, "_", " ")),
      y = "Density"
    )+
    theme_minimal() +
    theme(
      legend.position = "none",
      plot.title = element_text(face = "bold", hjust = .5)
      )
}
 
for (p in plot_density.w){
  print(p)
}
```

```{r}
plots.w <- list()
k <- 1

for (i in 1:(length(relevant_var.numeric.w)-1)) {
  for (j in (i+1):length(relevant_var.numeric.w)) {
    xvar <- relevant_var.numeric.w[i]
    yvar <- relevant_var.numeric.w[j]
    
    p <- ggplot(sub_train.w, aes_string(x = xvar, y = yvar,
                                         color = "Medalist", fill = "Medalist")) +
      geom_point(alpha = 0.4) +
      stat_ellipse(type = "norm", geom = "polygon", alpha = 0.1, color = NA) +
      theme_minimal() +
      labs(title = paste(xvar, "vs", yvar))
    
    plots.w[[k]] <- p
    k <- k + 1
  }
}

for (p in plots.w){
  print(p)
}
```

From the distribution plots doesn't seem to be any particular outlier. Furthermore, after the log trasformations, the normality seem to be respected by all of the variables and the variance and covariance seem to be shared by the classes.

```{r}
ggplot(reshape2::melt(sub_train.w[,relevant_var.numeric.w]), 
            aes(x = variable, y = value, fill = variable)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = NULL,
    y = NULL
  )+
  guides(fill = guide_legend(override.aes = list(linetype = 0, alpha = 1))) +
  theme_minimal() + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```
It's immediately apparent that the variables are distributed across significantly different scales. To compare them, it's useful to standardize them all onto the same scale. 

```{r}
summary_stat <- data.frame("Mean" = numeric(), "Median" = numeric())

for (i in seq_len(length(relevant_var.numeric.w))){
  summary_stat[i,"Mean"] <- round(mean(sub_train.w[[relevant_var.numeric.w[i]]]),3)
  summary_stat[i,"Median"] <- round(quantile(sub_train.w[[relevant_var.numeric.w[i]]], .5),3)
  summary_stat[i,"Var"] <- round(var(sub_train.w[[relevant_var.numeric.w[i]]]),5)
}

rownames(summary_stat) <-  relevant_var.numeric.w
```

```{r}
for (var in relevant_var.numeric.w){
  sub_train.w[,var] <- (sub_train.w[,var] - summary_stat[var, "Mean"])/sqrt(summary_stat[var, "Var"])
}
```

```{r}
ggplot(reshape2::melt(sub_train.w[,relevant_var.numeric.w]), 
            aes(x = variable, y = value, fill = variable)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = NULL,
    y = NULL
  )+
  guides(fill = guide_legend(override.aes = list(linetype = 0, alpha = 1))) +
  theme_minimal() + 
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```


## Classification algorithm

Given that the aim of the project is more oriented to be descriptive, I'll only evaluate the classification with logistc regression and with a decision tree.

### Logistic regression

```{r}
logistic.w <- glm(Medalist ~ ., sub_train.w[, c(relevant_var.numeric.w,relevant_var.vategorical.w, "Medalist")],
                family = binomial)
summary(logistic.w) # AIC: 7003.6
```
```{r}
logistic.step.w <- stepAIC(logistic.w, direction = "both", trace = FALSE)
summary(logistic.step.w) # AIC: 7001.6
```
Let's check if there's any influence point that could introduce bias in the model

```{r}
influencePlot(logistic.step.w)
```
Let's remove those point and calculate again the model

```{r}
influence_idx <- as.integer(row.names(influencePlot(logistic.step.w)))
logistic.w.no_influence <- glm(Medalist ~ ., sub_train.w[-influence_idx, c(relevant_var.numeric.w,relevant_var.vategorical.w, "Medalist")],
                family = binomial)
summary(logistic.w.no_influence) # AIC: 6973.5

```
```{r}
logistic.step.w.no_influence <- stepAIC(logistic.w.no_influence, direction = "both", trace = FALSE)
summary(logistic.step.w.no_influence) # AIC: 6971.5
```
```{r}
probabilities <- predict(logistic.step.w.no_influence, type = "response")
predictors <- c("debut_age", "weight", "participation_number")

supp <- sub_train.w[-influence_idx, predictors]
supp <- supp %>%
  mutate(logit = log(probabilities/(1-probabilities))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)

ggplot(supp, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5, colour = RColorBrewer::brewer.pal(n = 9, name = "Set1")[1]) +
  geom_smooth(method = "loess") + 
  theme_minimal() + 
  facet_wrap(~predictors, scales = "free_y")
```

```{r}
validation.w <- validation.w %>%
  mutate(debut_age = log(debut_age),
         participation_number = log(participation_number))
validation.w <- validation.w %>%
  mutate(
    sex = ifelse(is.na(sex), imputation_values.w$sex_mode, as.character(sex)),
    height = case_when(
      sex == "Male" & is.na(height) ~ male_height_median.w,
      sex == "Female" & is.na(height) ~ female_height_median.w,
      TRUE ~ height
    ),
    weight = case_when(
      sex == "Male" & is.na(weight) ~ male_weight_median.w,
      sex == "Female" & is.na(weight) ~ female_weight_median.w,
      TRUE ~ weight
    )
  )
for (var in relevant_var.numeric.w){
  validation.w[,var] <- (validation.w[,var] - summary_stat[var, "Mean"])/sqrt(summary_stat[var, "Var"])
}
```



```{r}
pred.logit <- predict(logistic.step.w.no_influence, validation.w[, c(relevant_var.numeric.w,relevant_var.vategorical.w)], type="response")
pred_logit_class <- ifelse (pred.logit > 0.5, 1, 0) 
logit.cof_matrix <- confusionMatrix(validation.w[["Medalist"]], factor(as.vector(pred_logit_class), levels=c(0,1)))
logit.cof_matrix
```
As shown by the results, the threshold of .5 doesn't not perfom at all, let's evaluate different values of threshold and see which one is the best.

```{r}
eval_metrics.trsh <- data.frame("Threshold" = character(), "Accuracy" = numeric(), "F1-score" = numeric())
```


```{r}

trsh <- c(0.001, 0.05, 0.1, 0.15, 0.2, 0.3, .4, .5)

for (i in seq_along(trsh)) {
  print(trsh[i])
  pred.class <- ifelse(pred.logit > trsh[i], 1, 0)
  pred.conf_matrix <- confusionMatrix(validation.w[["Medalist"]], 
                                      factor(as.vector(pred.class), levels=c(0,1)))
  print(pred.conf_matrix)
  
  Accuracy <- round(pred.conf_matrix$overall["Accuracy"], 2)
  Precision <- pred.conf_matrix$byClass["Pos Pred Value"]
  Recall <- pred.conf_matrix$byClass["Sensitivity"]
  F1 <- round((2 * Precision * Recall) / (Precision + Recall), 2)
  
  eval_metrics.trsh[i, ] <- c(trsh[i], Accuracy, F1)
}

eval_metrics.trsh
```

```{r}
eval_metrics.trsh.long <- pivot_longer(eval_metrics.trsh, cols = -Threshold, 
                          names_to = "Metric", values_to = "Value") %>%
  mutate(Value = as.numeric(Value))


ggplot(eval_metrics.trsh.long, aes(x = Threshold, y = Value, fill = Metric)) +
  geom_col(position = "dodge") +
  theme_minimal() +
  labs(
    title = "Confronto tra soglie",
    x = "Modello",
    y = "Valore",
    fill = "Soglia"
  ) +
  scale_fill_brewer(palette = "Set1") 
```
The best threshold seem to be .3
### Tree

```{r}
tree <- tree(Medalist ~. , sub_train.w[,c(relevant_var.numeric.w,relevant_var.vategorical.w, "Medalist")],
             mindev = 0.001,
             minsize = 5)
tree
```
```{r}
plot(tree)
text(tree, pretty = 0)
```
Given the strong imbalance of the classes (it is very rare to win a medal) the decision tree does not perform well at all, always classifying 0.
So I proceed to evaluate and confirm the perfonces of the logistic regression.

## Evaluation

### Train

```{r}
train.w <- train.w[complete.cases(train.w[, c("athlete_year_birth", "debut_age", "result_age")]), ]

imputation_values.w <- list(
  sex_mode = names(which.max(table(train.w$sex))),
  median_by_sex = train.w %>%
    group_by(sex) %>%
    summarize(
      height_median.w = median(height, na.rm = TRUE),
      weight_median.w = median(weight, na.rm = TRUE),
      .groups = 'drop'
    )
)
```

```{r}
male_height_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Male") %>%
  pull(height_median.w)

female_height_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Female") %>%
  pull(height_median.w)

male_weight_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Male") %>%
  pull(weight_median.w)

female_weight_median.w <- imputation_values.w$median_by_sex %>%
  filter(!is.na(sex) & sex == "Female") %>%
  pull(weight_median.w)

train.w <- train.w %>%
  mutate(
    sex = ifelse(is.na(sex), imputation_values.w$sex_mode, as.character(sex)),
    height = case_when(
      sex == "Male" & is.na(height) ~ male_height_median.w,
      sex == "Female" & is.na(height) ~ female_height_median.w,
      TRUE ~ height
    ),
    weight = case_when(
      sex == "Male" & is.na(weight) ~ male_weight_median.w,
      sex == "Female" & is.na(weight) ~ female_weight_median.w,
      TRUE ~ weight
    )
  )

```

```{r}
summary_stat <- data.frame("Mean" = numeric(), "Median" = numeric())

for (i in seq_len(length(relevant_var.numeric.w))){
  summary_stat[i,"Mean"] <- round(mean(train.w[[relevant_var.numeric.w[i]]]),3)
  summary_stat[i,"Median"] <- round(quantile(train.w[[relevant_var.numeric.w[i]]], .5),3)
  summary_stat[i,"Var"] <- round(var(train.w[[relevant_var.numeric.w[i]]]),5)
}

rownames(summary_stat) <-  relevant_var.numeric.w
```


```{r}
train.w$debut_age <- log(train.w$debut_age)
train.w$participation_number <- log(train.w$participation_number)
for (var in relevant_var.numeric.w){
  train.w[,var] <- (train.w[,var] - summary_stat[var, "Mean"])/sqrt(summary_stat[var, "Var"])
}
```

```{r}
logit.final <- glm(formula = Medalist ~ debut_age + weight + participation_number + 
    participant_type + sex + HomeGame, family = binomial, data = train.w[, 
    c(relevant_var.numeric.w, relevant_var.vategorical.w, "Medalist")])
summary(logit.final) # AIC: 9367
```
```{r}
influence_idx <- as.integer(row.names(influencePlot(logit.final)))
logit.final.no_influence <- glm(formula = Medalist ~ debut_age + weight + participation_number + 
    participant_type + sex + HomeGame, family = binomial, data = train.w[-influence_idx, 
    c(relevant_var.numeric.w, relevant_var.vategorical.w, "Medalist")])
summary(logit.final.no_influence) # AIC: 9337.3
```
### Test

```{r}
summary(test.w)
```

```{r}
test.w <- test.w[complete.cases(test.w[, c("athlete_year_birth", "debut_age", "result_age")]), ]
```

```{r}

test.w <- test.w %>%
  mutate(
    sex = ifelse(is.na(sex), imputation_values.w$sex_mode, as.character(sex)),
    height = case_when(
      sex == "Male" & is.na(height) ~ male_height_median.w,
      sex == "Female" & is.na(height) ~ female_height_median.w,
      TRUE ~ height
    ),
    weight = case_when(
      sex == "Male" & is.na(weight) ~ male_weight_median.w,
      sex == "Female" & is.na(weight) ~ female_weight_median.w,
      TRUE ~ weight
    )
  )

```

```{r}
summary_stat <- data.frame("Mean" = numeric(), "Median" = numeric())

for (i in seq_len(length(relevant_var.numeric.w))){
  summary_stat[i,"Mean"] <- round(mean(test.w[[relevant_var.numeric.w[i]]]),3)
  summary_stat[i,"Median"] <- round(quantile(test.w[[relevant_var.numeric.w[i]]], .5),3)
  summary_stat[i,"Var"] <- round(var(test.w[[relevant_var.numeric.w[i]]]),5)
}

rownames(summary_stat) <-  relevant_var.numeric.w
```


```{r}
test.w$debut_age <- log(test.w$debut_age)
test.w$participation_number <- log(test.w$participation_number)
for (var in relevant_var.numeric.w){
  test.w[,var] <- (test.w[,var] - summary_stat[var, "Mean"])/sqrt(summary_stat[var, "Var"])
}
```

```{r}
pred_logit.final <- predict(logit.final.no_influence, test.w[, c(relevant_var.numeric.w,relevant_var.vategorical.w)], type="response")
pred_logit_class.final <- ifelse(pred_logit.final > .3,1,0)
```

```{r}
confusionMatrix(factor(test.w[["Medalist"]]), factor(as.vector(pred_logit_class.final)))
```

```{r}
pred_logit.ROC <- prediction(pred_logit.final, test.w[["Medalist"]])
perf_logit <- performance(pred_logit.ROC,"tpr","fpr")
auc_logit <- performance(pred_logit.ROC, measure = "auc")@y.values
auc_logit
```

```{r}
roc_df <- data.frame(
  FPR = unlist(perf_logit@x.values),
  TPR = unlist(perf_logit@y.values),
  cutoff = unlist(perf_logit@alpha.values)
)

ggplot(roc_df, aes(x = FPR, y = TPR, color = cutoff)) +
  geom_line(size = 1.2) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black", size = 1) +
  scale_color_gradientn(colors = rainbow(7)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = .5)
  )+
  labs(
    title = "ROC curve with colored threshold",
    x = "False Positive Rate",
    y = "True Positive Rate",
    color = "theshold"
  ) + 
  annotate(
    "text",
    x = 0.6, y = 0.2,   
    label = paste("AUC =", round(as.numeric(auc_logit), 3)),
    size = 5,
    color = "black",
  )
```

The model does't seem to perform very well but can give us an idea about what does it it takes to win a medal. In particular it highlights that winning an Olympic medal is not a matter of chance but the result of several measurable factors. Between those the most remarkable are:
- Athletes debuting at a younger age have a higher probability of reaching the podium, reflecting the importance of early specialization and long-term career development;
- The number of participations is one of the strongest predictors: experience accumulated across multiple Games significantly increases the chances of success;
- Being part of a GameTeam rather than competing individually also improves the odds, as collective events tend to guarantee more stable performances. 
- Competing at home (HomeGame) offers a tangible advantage, confirming the existence of a “home effect” in the Olympic Games.